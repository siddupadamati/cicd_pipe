name: SQL DELETE Detector

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  detect-delete:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # IMPORTANT

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}

      - name: Detect changed SQL
        id: scan
        run: |
          # Fetch base branch (main or whatever PR targets)
          git fetch origin ${{ github.base_ref }}
      
          # Compare PR branch changes to base branch
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -Ei '\.sql$' || true)
      
          echo "Changed SQL files:"
          echo "$CHANGED"
      
          if [ -z "$CHANGED" ]; then
            echo "delete_found=no" >> $GITHUB_OUTPUT
            exit 0
          fi
      
          if git diff origin/${{ github.base_ref }}...HEAD -- $CHANGED | grep -iq "delete"; then
            echo "delete_found=yes" >> $GITHUB_OUTPUT
          else
            echo "delete_found=no" >> $GITHUB_OUTPUT
          fi

      - name: Add label if DELETE found
        if: steps.scan.outputs.delete_found == 'yes'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: "requires-secondary-approval"
