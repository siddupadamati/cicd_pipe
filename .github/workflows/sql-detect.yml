name: Detect DELETE in SQL (No Git Diff)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  detect-delete:
    runs-on: ubuntu-latest

    steps:
      - name: Detect DELETE in SQL using GitHub API
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // Get changed files from the PR
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            let deleteFound = false;

            for (const file of files.data) {
              // Only check .sql files
              if (file.filename.endsWith(".sql")) {
                const patch = file.patch || "";

                // Look for DELETE statements in the patch
                if (/delete/i.test(patch)) {
                  deleteFound = true;
                  break;
                }
              }
            }

            core.setOutput("delete_found", deleteFound ? "yes" : "no");

      - name: Add label if DELETE FOUND
        if: steps.detect.outputs.delete_found == 'yes'
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: "requires-secondary-approval"
